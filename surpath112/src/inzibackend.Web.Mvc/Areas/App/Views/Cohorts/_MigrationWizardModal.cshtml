@using inzibackend.Web.Areas.App.Models.Common.Modals
@using inzibackend.Web.Areas.App.Models.Cohorts
@using Microsoft.AspNetCore.Mvc.Rendering
@model CohortMigrationWizardViewModel

@await Html.PartialAsync("~/Areas/App/Views/Common/Modals/_ModalHeader.cshtml", new ModalHeaderViewModel(L("MigrateCohort") + " - " + Model.CohortName))

<div class="modal-body">
    <!-- Wizard Progress Indicator -->
    <div class="wizard-progress mb-4">
        <div class="d-flex justify-content-between">
            <div class="step-item @(Model.CurrentStep >= 1 ? "active" : "") @(Model.CurrentStep > 1 ? "completed" : "")">
                <div class="step-number">1</div>
                <div class="step-title">@L("DepartmentSelection")</div>
            </div>
            <div class="step-item @(Model.CurrentStep >= 2 ? "active" : "") @(Model.CurrentStep > 2 ? "completed" : "")">
                <div class="step-number">2</div>
                <div class="step-title">@L("CategoryMapping")</div>
            </div>
            <div class="step-item @(Model.CurrentStep >= 3 ? "active" : "") @(Model.CurrentStep > 3 ? "completed" : "")">
                <div class="step-number">3</div>
                <div class="step-title">@L("Confirmation")</div>
            </div>
        </div>
        <div class="progress mt-2">
            <div class="progress-bar" role="progressbar" style="width: @((Model.CurrentStep - 1) * 50)%" aria-valuenow="@((Model.CurrentStep - 1) * 50)" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!-- Hidden model data for JavaScript access (outside form to prevent submission) -->
    <div class="d-none" id="migrationWizardModelData">
        <input type="hidden" name="CohortMigrationWizardViewModel_CohortId" value="@Model.CohortId" />
        <input type="hidden" name="CohortMigrationWizardViewModel_CohortName" value="@Model.CohortName" />
        <input type="hidden" name="CohortMigrationWizardViewModel_SourceDepartmentName" value="@Model.SourceDepartmentName" />
        <input type="hidden" name="CohortMigrationWizardViewModel_DepartmentOption" value="@Model.DepartmentOption" />
        <input type="hidden" name="CohortMigrationWizardViewModel_TargetDepartmentId" value="@Model.TargetDepartmentId" />
        <input type="hidden" name="CohortMigrationWizardViewModel_NewDepartmentName" value="@Model.NewDepartmentName" />
        <input type="hidden" name="CohortMigrationWizardViewModel_NewDepartmentDescription" value="@Model.NewDepartmentDescription" />
        <input type="hidden" name="CohortMigrationWizardViewModel_CurrentStep" value="@Model.CurrentStep" />
    </div>

    <!-- Migration Wizard Form -->
    <form name="MigrationWizardForm" role="form" novalidate class="form-validation">
        <input type="hidden" name="cohortId" value="@Model.CohortId" />
        <input type="hidden" name="currentStep" value="@Model.CurrentStep" />

        <!-- Step 1: Department Selection -->
        <div id="step1" class="wizard-step @(Model.CurrentStep == 1 ? "active" : "d-none")">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">@L("SelectTargetDepartment")</h5>
                    <p class="text-muted mb-0">@L("ChooseDestinationForCohort")</p>
                </div>
                <div class="card-body">
                    <!-- Source Department Info -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading">@L("CurrentDepartment")</h6>
                        <p class="mb-0">
                            <strong>@L("Cohort"):</strong> @Model.CohortName<br />
                            <strong>@L("Department"):</strong> @(Model.SourceDepartmentName ?? L("NoDepartment"))
                        </p>
                    </div>

                    <!-- Department Selection Options -->
                    <div class="form-group mb-4">
                        <label class="form-label">@L("MigrationOption")</label>
                        <div class="mt-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="departmentOption" id="existingDepartment" value="existing" @Html.Raw(Model.DepartmentOption == "existing" ? "checked" : "")>
                                <label class="form-check-label" for="existingDepartment">
                                    <strong>@L("MigrateToExistingDepartment")</strong>
                                    <br><small class="text-muted">@L("SelectFromAvailableDepartments")</small>
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="departmentOption" id="newDepartment" value="new" @Html.Raw(Model.DepartmentOption == "new" ? "checked" : "")>
                                <label class="form-check-label" for="newDepartment">
                                    <strong>@L("CreateNewDepartment")</strong>
                                    <br><small class="text-muted">@L("CreateNewDepartmentForCohort")</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Department Selection -->
                    <div id="existingDepartmentSection" class="@(Model.DepartmentOption == "existing" ? "" : "d-none")">
                        <div class="form-group mb-3">
                            <label class="form-label" for="targetDepartmentId">@L("SelectDepartment") <span class="text-danger">*</span></label>
                            @Html.DropDownList("targetDepartmentId", 
                                new SelectList(Model.AvailableDepartments, "DepartmentId", "DepartmentName", Model.TargetDepartmentId), 
                                L("PleaseSelect"), 
                                new { @class = "form-control", id = "targetDepartmentId" })
                        </div>
                        
                        <!-- Department Statistics -->
                        <div id="departmentStats" class="d-none">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">@L("DepartmentStatistics")</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="stat-item">
                                                <span class="stat-label">@L("Cohorts"):</span>
                                                <span class="stat-value" id="statsCohortsCount">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-item">
                                                <span class="stat-label">@L("Users"):</span>
                                                <span class="stat-value" id="statsUsersCount">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-item">
                                                <span class="stat-label">@L("Requirements"):</span>
                                                <span class="stat-value" id="statsRequirementsCount">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Department Creation -->
                    <div id="newDepartmentSection" class="@(Model.DepartmentOption == "new" ? "" : "d-none")">
                        <div class="form-group mb-3">
                            <label class="form-label" for="newDepartmentName">@L("DepartmentName") <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newDepartmentName" name="newDepartmentName" value="@Model.NewDepartmentName" placeholder="@L("EnterDepartmentName")" />
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label" for="newDepartmentDescription">@L("Description")</label>
                            <textarea class="form-control" id="newDepartmentDescription" name="newDepartmentDescription" rows="3" placeholder="@L("EnterDepartmentDescription")">@Model.NewDepartmentDescription</textarea>
                        </div>
                    </div>

                    <!-- Migration Analysis Results -->
                    <div id="migrationAnalysis" class="d-none">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="card-title mb-0">@L("MigrationAnalysis")</h6>
                            </div>
                            <div class="card-body">
                                <div id="analysisContent">
                                    <!-- Analysis content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Category Mapping -->
        <div id="step2" class="wizard-step @(Model.CurrentStep == 2 ? "active" : "d-none")">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">@L("RequirementCategoryMapping")</h5>
                    <p class="text-muted mb-0">@L("MapCategoriesForMigration")</p>
                </div>
                <div class="card-body">
                    <!-- Migration Analysis Summary -->
                    <div id="migrationSummary" class="alert alert-info mb-4 d-none">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6 class="mb-1">@L("TotalCategories")</h6>
                                    <span class="badge badge-primary" id="totalCategoriesCount">0</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6 class="mb-1">@L("AffectedUsers")</h6>
                                    <span class="badge badge-warning" id="totalAffectedUsers">0</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6 class="mb-1">@L("RecordStates")</h6>
                                    <span class="badge badge-info" id="totalRecordStates">0</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6 class="mb-1">@L("MappingProgress")</h6>
                                    <span class="badge badge-success" id="mappingProgress">0/0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No Migration Required Section (shown first) -->
                    <div id="noMigrationRequiredSection" class="mb-4 d-none">
                        <div class="card border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">
                                    <i class="fa fa-check-circle"></i>
                                    @L("RequirementsWithNoMigrationRequired")
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <i class="fa fa-info-circle"></i>
                                    @L("TheseRequirementsApplyBothBeforeAndAfterMigrationNoActionRequired")
                                </p>
                                <div id="noMigrationRequiredList">
                                    <!-- List will be populated via JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="bulkMapBtn">
                                    <i class="fa fa-link"></i> @L("BulkMap")
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="bulkCopyBtn">
                                    <i class="fa fa-copy"></i> @L("BulkCopy")
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" id="bulkSkipBtn">
                                    <i class="fa fa-skip-forward"></i> @L("BulkSkip")
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-outline-info btn-sm" id="autoSuggestBtn">
                                <i class="fa fa-magic"></i> @L("AutoSuggest")
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" id="validateMappingsBtn">
                                <i class="fa fa-check"></i> @L("ValidateMappings")
                            </button>
                        </div>
                    </div>

                    <!-- Category Mapping Table -->
                    <div class="table-responsive">
                        <table id="categoryMappingTable" class="table table-striped table-bordered table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th width="5%">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllCategories">
                                        </div>
                                    </th>
                                    <th width="20%">@L("SourceCategory")</th>
                                    <th width="15%">@L("Requirement")</th>
                                    <th width="10%">@L("Impact")</th>
                                    <th width="15%">@L("MappingAction")</th>
                                    <th width="20%">@L("TargetMapping")</th>
                                    <th width="10%">@L("Suggestions")</th>
                                    <th width="5%">@L("Status")</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Loading State -->
                    <div id="categoryMappingLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">@L("Loading")</span>
                        </div>
                        <p class="mt-2 text-muted">@L("LoadingCategoryData")</p>
                    </div>

                    <!-- Validation Messages -->
                    <div id="mappingValidationMessages" class="mt-3 d-none">
                        <div class="alert alert-warning">
                            <h6 class="alert-heading">@L("ValidationIssues")</h6>
                            <ul id="validationIssuesList" class="mb-0">
                                <!-- Validation issues will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div id="step3" class="wizard-step @(Model.CurrentStep == 3 ? "active" : "d-none")">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">@L("ConfirmMigration")</h5>
                    <p class="text-muted mb-0">@L("ReviewAndExecuteMigration")</p>
                </div>
                <div class="card-body">
                    <!-- Migration Summary -->
                    <div class="mb-4">
                        <h6 class="mb-3">@L("MigrationSummary")</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <strong>@L("SourceCohort"):</strong> <span id="confirmCohortName"></span>
                                </div>
                                <div class="info-item mb-2">
                                    <strong>@L("SourceDepartment"):</strong> <span id="confirmSourceDepartment"></span>
                                </div>
                                <div class="info-item mb-2">
                                    <strong>@L("TargetDepartment"):</strong> <span id="confirmTargetDepartment"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <strong>@L("TotalUsers"):</strong> <span id="confirmTotalUsers"></span>
                                </div>
                                <div class="info-item mb-2">
                                    <strong>@L("EstimatedDuration"):</strong> <span id="confirmEstimatedDuration"></span> @L("Minutes")
                                </div>
                                <div class="info-item mb-2">
                                    <strong>@L("MigrationComplexity"):</strong> <span id="confirmComplexity"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category Mapping Summary -->
                    <div class="mb-4">
                        <h6 class="mb-3">@L("CategoryMappingSummary")</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="summary-metric">
                                            <div class="metric-value text-primary" id="confirmMappedCategories">0</div>
                                            <div class="metric-label">@L("MappedToExisting")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="summary-metric">
                                            <div class="metric-value text-success" id="confirmCopiedCategories">0</div>
                                            <div class="metric-label">@L("CopiedAsNew")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="summary-metric">
                                            <div class="metric-value text-warning" id="confirmSkippedCategories">0</div>
                                            <div class="metric-label">@L("Skipped")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="summary-metric">
                                            <div class="metric-value text-info" id="confirmNoMigrationRequired">0</div>
                                            <div class="metric-label">@L("NoMigrationRequired")</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 text-center">
                                    <small class="text-muted">
                                        <strong>@L("TotalCategories"):</strong> <span id="confirmTotalCategories">0</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Impact Summary -->
                    <div class="mb-4" id="impactSummarySection" style="display: none;">
                        <h6 class="mb-3">@L("ImpactSummary")</h6>
                        <div class="alert alert-warning" id="dataLossWarning" style="display: none;">
                            <i class="fa fa-exclamation-triangle"></i>
                            <strong>@L("Warning"):</strong> <span id="dataLossMessage"></span>
                        </div>
                        <ul class="list-unstyled">
                            <li><i class="fa fa-users text-primary"></i> <span id="confirmAffectedUsers"></span> @L("UsersWillBeAffected")</li>
                            <li><i class="fa fa-file-alt text-info"></i> <span id="confirmAffectedRecords"></span> @L("RecordStatesWillBeMigrated")</li>
                            <li id="newRequirementsItem" style="display: none;">
                                <i class="fa fa-plus-circle text-success"></i> <span id="confirmNewRequirements"></span> @L("NewRequirementsWillBeCreated")
                            </li>
                            <li id="newCategoriesItem" style="display: none;">
                                <i class="fa fa-folder-plus text-success"></i> <span id="confirmNewCategories"></span> @L("NewCategoriesWillBeCreated")
                            </li>
                        </ul>
                    </div>

                    <!-- Warnings -->
                    <div class="mb-4" id="warningsSection" style="display: none;">
                        <h6 class="mb-3 text-warning">@L("Warnings")</h6>
                        <div class="alert alert-warning">
                            <ul id="warningsList" class="mb-0">
                                <!-- Warnings will be populated dynamically -->
                            </ul>
                        </div>
                    </div>

                    <!-- Final Confirmation -->
                    <div class="card border-primary">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmMigration" name="confirmMigration">
                                <label class="form-check-label" for="confirmMigration">
                                    <strong>@L("IConfirmMigrationReadiness")</strong>
                                    <br>
                                    <small class="text-muted">@L("MigrationCannotBeUndoneAutomatically")</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Custom Modal Footer with Wizard Navigation -->
<div class="modal-footer">
    <button type="button" class="btn btn-light-primary" data-bs-dismiss="modal">@L("Cancel")</button>
    <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;">
        <i class="fa fa-arrow-left"></i> @L("Previous")
    </button>
    <button type="button" class="btn btn-primary" id="nextStepBtn">
        @L("Next") <i class="fa fa-arrow-right"></i>
    </button>
    <button type="button" class="btn btn-success" id="executeBtn" style="display: none;">
        <i class="fa fa-play"></i> @L("ExecuteMigration")
    </button>
</div> 